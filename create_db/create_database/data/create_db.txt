DROP TABLE IF EXISTS BOOKS;

CREATE TABLE IF NOT EXISTS BOOKS(
	isbn		INTEGER	PRIMARY KEY	CHECK(LENGTH(isbn) = 13),
	title		TEXT	NOT NULL
);

DROP TABLE IF EXISTS AUTHORS;

CREATE TABLE IF NOT EXISTS AUTHORS(
	author_id	INTEGER	PRIMARY KEY	AUTOINCREMENT,
	name		TEXT	NOT NULL UNIQUE
);

DROP TABLE IF EXISTS BOOK_AUTHORS;

CREATE TABLE IF NOT EXISTS BOOK_AUTHORS(
	author_id	INTEGER,
	isbn		INTEGER,
	FOREIGN KEY(author_id) REFERENCES AUTHORS(author_id),
	FOREIGN KEY(isbn) REFERENCES BOOKS(isbn)
);

DROP TABLE IF EXISTS BNAMES;

CREATE TABLE IF NOT EXISTS BNAMES(
	bname_id	INTEGER PRIMARY KEY AUTOINCREMENT,
	fname		TEXT	NOT NULL,
	lname		TEXT	NOT NULL
);

DROP TABLE IF EXISTS ADDRESSES;

CREATE TABLE IF NOT EXISTS ADDRESSES(
	address_id	INTEGER PRIMARY KEY AUTOINCREMENT,
	address		TEXT	NOT NULL,
	city		TEXT	NOT NULL,
	state_ab	CHARACTER(2)	NOT NULL
);

DROP TABLE IF EXISTS BORROWERS;

CREATE TABLE IF NOT EXISTS BORROWERS(
	card_id		INTEGER	PRIMARY KEY AUTOINCREMENT,
	ssn			INTEGER NOT NULL UNIQUE CHECK(LENGTH(ssn) = 9),
	bname_id	INTEGER	NOT NULL,
	address_id	INTEGER NOT NULL,
	phone		INTEGER CHECK(LENGTH(phone) = 10),
	FOREIGN KEY(bname_id) REFERENCES BNAMES(bname_id)
	FOREIGN KEY(address_id) REFERENCES ADDRESSES(address_id)
);

DROP TABLE IF EXISTS BOOK_LOANS;

CREATE TABLE IF NOT EXISTS BOOK_LOANS(
	loan_id		INTEGER PRIMARY KEY AUTOINCREMENT,
	isbn		INTEGER	UNIQUE NOT NULL,
	card_id		INTEGER NOT NULL,
	date_out	INTEGER DEFAULT 0,
	due_date	INTEGER AS (date_out + 1209600) STORED,
	date_in		INTEGER,
	FOREIGN KEY(isbn) REFERENCES BOOKS(isbn),
	FOREIGN KEY(card_id) REFERENCES BORROWERS(card_id)
);

DROP TABLE IF EXISTS FINES;

CREATE TABLE IF NOT EXISTS FINES(
	loan_id		INTEGER	PRIMARY KEY,
	fine_amt	DECIMAL(6,2)	DEFAULT 0,
	paid		BOOLEAN	DEFAULT FALSE,
	FOREIGN KEY(loan_id) REFERENCES BOOK_LOANS(loan_id)
);